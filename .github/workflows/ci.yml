name: CI

on:
  pull_request:
    branches:
      - 'main'
  push:
    branches:
      - 'main'

permissions:
  contents: read

defaults:
  run:
    shell: bash

env:
  IS_CI: "yes"

jobs:
  sanity_check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Erlang
        uses: erlef/setup-beam@v1
        with:
          otp-version: '27.2.3'
          rebar3-version: '3.24.0'

      - name: Cache Cargo Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            crates/greptimedb-ingester-nif/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cache Rebar3 Dependencies
        uses: actions/cache@v4
        with:
          path: _build
          key: ${{ runner.os }}-rebar3-${{ hashFiles('rebar.lock') }}
          restore-keys: |
            ${{ runner.os }}-rebar3-

      - name: Check Rust format
        run: |
          cargo fmt --check

      - name: Check Erlang format
        run: |
          rebar3 fmt -c --verbose

      - name: Check TOML format
        run: |
          curl -fsSL https://github.com/tamasfe/taplo/releases/latest/download/taplo-linux-x86_64.gz \
            | gzip -d - | install -m 755 /dev/stdin /usr/local/bin/taplo
          taplo format --check --diff

      - name: Setup Protobuf Compiler
        run: |
          sudo apt-get update && sudo apt-get install -y protobuf-compiler
          protoc --version

      - name: Cargo Check
        run: |
          cargo check

      - name: Check Rust clippy
        run: |
          rustup toolchain list
          cargo clippy --workspace --all-targets --all-features -- -D warnings

      - name: Check Cargo-deny
        uses: EmbarkStudios/cargo-deny-action@v1
        with:
          log-level: error
          arguments: --all-features
          command: check -s licenses sources bans

      - name: Check project build
        run: |
          rebar3 compile

      - name: Package Build Artifacts
        run: |
          zip -ryq build-artifacts.zip . -x "*.git*"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: build-artifacts.zip
          retention-days: 1
          if-no-files-found: error

  common_test:
    runs-on: ubuntu-latest
    needs: sanity_check
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts

      - name: Extract Build Artifacts
        run: |
          unzip -q build-artifacts.zip
          rm build-artifacts.zip

      - name: Setup Erlang
        uses: erlef/setup-beam@v1
        with:
          otp-version: '27.2.3'
          rebar3-version: '3.24.0'

      - name: Start GreptimeDB Container
        run: |
          source .ci/docker-compose-file/.env
          docker compose -f .ci/docker-compose-file/docker-compose-greptimedb.yaml up -d

      - name: Run Common Test
        run: |
          source env.sh
          make ct-docker
